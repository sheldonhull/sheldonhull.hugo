<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta itemprop="name" content="Stranger Danger... The need for trust with constraints">
<meta itemprop="description" content="I ran into an issue with errors with an database upgrade running into a violation of a foreign key constraint. Don&rsquo;t know how it happened. Figured that while I&rsquo;m at it, I&rsquo;d go ahead and evaluate every single check constraint in the database to see if I could identify any other violations, because they shouldn&rsquo;t be happening.
improve the execution plan by checking the data In my reading, I found out that checking the constraints can enable the constraint to be marked as trusted.">


<meta itemprop="datePublished" content="2015-08-13T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2015-08-13T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="307">



<meta itemprop="keywords" content="sql-server," />
<meta property="og:title" content="Stranger Danger... The need for trust with constraints" />
<meta property="og:description" content="I ran into an issue with errors with an database upgrade running into a violation of a foreign key constraint. Don&rsquo;t know how it happened. Figured that while I&rsquo;m at it, I&rsquo;d go ahead and evaluate every single check constraint in the database to see if I could identify any other violations, because they shouldn&rsquo;t be happening.
improve the execution plan by checking the data In my reading, I found out that checking the constraints can enable the constraint to be marked as trusted." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sheldonhull.com/blog/2015-08-13-stranger-danger...-the-need-for-trust-with-constraints/" />
<meta property="article:published_time" content="2015-08-13T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2015-08-13T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Stranger Danger... The need for trust with constraints"/>
<meta name="twitter:description" content="I ran into an issue with errors with an database upgrade running into a violation of a foreign key constraint. Don&rsquo;t know how it happened. Figured that while I&rsquo;m at it, I&rsquo;d go ahead and evaluate every single check constraint in the database to see if I could identify any other violations, because they shouldn&rsquo;t be happening.
improve the execution plan by checking the data In my reading, I found out that checking the constraints can enable the constraint to be marked as trusted."/>

	<link rel="apple-touch-icon" sizes="180x180" href="https://www.sheldonhull.com/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.sheldonhull.com/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.sheldonhull.com/favicon-16x16.png">
	<link rel="manifest" href="https://www.sheldonhull.com/site.webmanifest">
	<link rel="mask-icon" href="https://www.sheldonhull.com/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="https://www.sheldonhull.com/favicon.ico">

	<title>Stranger Danger... The need for trust with constraints</title>
	<link rel="stylesheet" href="https://www.sheldonhull.com/css/style.min.31706917653d2b9e8410abd431f30ec4359a88a94fc87a63654779d87329edec.css" integrity="sha256-MXBpF2U9K56EEKvUMfMOxDWaiKlPyHpjZUd52HMp7ew=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.sheldonhull.com">sheldonhull.com</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.sheldonhull.com/blog/">Blog</a>
					<a href="https://www.sheldonhull.com/docs/">Docs</a>
					<a href="https://www.sheldonhull.com/tags/">Tags</a>
					<a href="https://www.sheldonhull.com/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.sheldonhull.com/blog/">Blog</a></li>
			<li><a href="https://www.sheldonhull.com/docs/">Docs</a></li>
			<li><a href="https://www.sheldonhull.com/tags/">Tags</a></li>
			<li><a href="https://www.sheldonhull.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>Stranger Danger... The need for trust with constraints</h1>
		<div class="content">
			

<p>I ran into an issue with errors with an database upgrade running into a violation of a foreign key constraint. Don&rsquo;t know how it happened. Figured that while I&rsquo;m at it, I&rsquo;d go ahead and evaluate every single check constraint in the database to see if I could identify any other violations, because they shouldn&rsquo;t be happening.</p>

<h2 id="improve-the-execution-plan-by-checking-the-data">improve the execution plan by checking the data<a href="#improve-the-execution-plan-by-checking-the-data" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>In my reading, I found out that checking the constraints can enable the constraint to be marked as trusted. The trusted constraints are then able to be used to build a better query plan execution.
I knew that constraints could help the execution, but didn&rsquo;t know that they could have a trusted or untrusted trait.</p>

<h2 id="brentozar-to-the-rescue">Brentozar to the rescue<a href="#brentozar-to-the-rescue" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>I&rsquo;m serious, this guy and his team are awesome. This one single team and their web resources have single handled helped me gain more understanding on SQL server than any other resource. I love how they give back to the community, and their communication always is full of humor and good examples. Kudos!
Anyway, commendation aside, the explanation from sp_blitz was fantastic at summarizing the issue.</p>

<blockquote>
<p>After this change, you may see improved query performance for tables with trusted keys and constraints. - <a href="http://www.brentozar.com/blitz/foreign-key-trusted/">Blitz Result: Foreign Keys or Check Constraints Not Trusted</a>
  As the site further mentions, this can cause locks and performance issues, so this validation might be better done off hours. The benefit might be worth it though!</p>
</blockquote>

<h2 id="my-adaption-of-the-check-constraint-script">my adaption of the check constraint script<a href="#my-adaption-of-the-check-constraint-script" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>I appreciate the script as a starting point (see link above). I adapted to run this individually on each check constraint and log the errors that occurred. This runs though all FK and CHECK constraints in the database you are in, and then checks the data behind the constraint to ensure it is noted as trusted.</p>

<script type="text/javascript" src="https://gist.github.com/2454ce9134eac225ce264c64adb331a9.js"></script>


		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.sheldonhull.com"></a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.sheldonhull.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.sheldonhull.com/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
