<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta itemprop="name" content="Quick Way to Run Powershell Tasks in Parallel">
<meta itemprop="description" content="Running tasks in parallel can be a bit difficult in powershell. However, there are a few projects out there that optimize the performance and provide a better experience of running tasks in parallel with less effort.#cool uses A few cool uses of this might be running parallel sql queries across multiple servers or databases while maintaining a throttled limit to avoid saturation of the target environment. Additionally, long running queries might benefit in running in parallel if running on multiple objects in the same database or in different databases.">


<meta itemprop="datePublished" content="2017-02-18T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-02-18T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="905">



<meta itemprop="keywords" content="powershell,sql-server," />
<meta property="og:title" content="Quick Way to Run Powershell Tasks in Parallel" />
<meta property="og:description" content="Running tasks in parallel can be a bit difficult in powershell. However, there are a few projects out there that optimize the performance and provide a better experience of running tasks in parallel with less effort.#cool uses A few cool uses of this might be running parallel sql queries across multiple servers or databases while maintaining a throttled limit to avoid saturation of the target environment. Additionally, long running queries might benefit in running in parallel if running on multiple objects in the same database or in different databases." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sheldonhull.com/blog/2017-02-18-quick-way-to-run-powershell-tasks-in-parallel/" />
<meta property="article:published_time" content="2017-02-18T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2017-02-18T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Quick Way to Run Powershell Tasks in Parallel"/>
<meta name="twitter:description" content="Running tasks in parallel can be a bit difficult in powershell. However, there are a few projects out there that optimize the performance and provide a better experience of running tasks in parallel with less effort.#cool uses A few cool uses of this might be running parallel sql queries across multiple servers or databases while maintaining a throttled limit to avoid saturation of the target environment. Additionally, long running queries might benefit in running in parallel if running on multiple objects in the same database or in different databases."/>

	<link rel="apple-touch-icon" sizes="180x180" href="https://www.sheldonhull.com/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.sheldonhull.com/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.sheldonhull.com/favicon-16x16.png">
	<link rel="manifest" href="https://www.sheldonhull.com/site.webmanifest">
	<link rel="mask-icon" href="https://www.sheldonhull.com/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="https://www.sheldonhull.com/favicon.ico">

	<title>Quick Way to Run Powershell Tasks in Parallel</title>
	<link rel="stylesheet" href="https://www.sheldonhull.com/css/style.min.31706917653d2b9e8410abd431f30ec4359a88a94fc87a63654779d87329edec.css" integrity="sha256-MXBpF2U9K56EEKvUMfMOxDWaiKlPyHpjZUd52HMp7ew=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.sheldonhull.com">sheldonhull.com</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.sheldonhull.com/blog/">Blog</a>
					<a href="https://www.sheldonhull.com/docs/">Docs</a>
					<a href="https://www.sheldonhull.com/tags/">Tags</a>
					<a href="https://www.sheldonhull.com/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.sheldonhull.com/blog/">Blog</a></li>
			<li><a href="https://www.sheldonhull.com/docs/">Docs</a></li>
			<li><a href="https://www.sheldonhull.com/tags/">Tags</a></li>
			<li><a href="https://www.sheldonhull.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>Quick Way to Run Powershell Tasks in Parallel</h1>
		<div class="content">
			

<p>Running tasks in parallel can be a bit difficult in powershell. However, there are a few projects out there that optimize the performance and provide a better experience of running tasks in parallel with less effort.#cool uses
A few cool uses of this might be running parallel sql queries across multiple servers or databases while maintaining a throttled limit to avoid saturation of the target environment. Additionally, long running queries might benefit in running in parallel if running on multiple objects in the same database or in different databases.</p>

<h1 id="module-magic">module magic<a href="#module-magic" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>

<p>I&rsquo;ve utilized two main modules to advance this.
<a href="https://github.com/powercode/PSParallel">PSParallel</a> and <a href="https://github.com/proxb/PoshRSJob/">PoshRSJobs</a>. Both are fantastic options. The Invoke-Parallel is not steadily maintained, so I try to use PoshRSJob when possible. However, for ease of use the Invoke-Parallel option is pretty awesome as it automatically imports variables, functions, and modules into the block to allow for less work in defining parameters, having to use the <code>$using:variablename</code> clause, etc.</p>

<h1 id="lots-of-gotchas">lots of gotchas<a href="#lots-of-gotchas" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>

<p>However, be prepared to deal with some complications in doing this with powershell. For instance, write-host, write-verbose, write-error, at this time can throw errors in PoshRSJob or not provide any output, as these streams are not incorporated the same as your local ISE session. In fact, at the time of this post, for output to stream from the PoshRSJob module, I had to change my output from:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">write-host</span> <span class="s1">&#39;I know a kitten dies every time writehost is used, but I just cannot stop myself&#39;</span></code></pre></div>
<p>to</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="s2">&#34;I know a kitten dies every time writehost is used, but I just cannot stop myself&#34;</span></code></pre></div>
<p>Yes&hellip; no write-host/write-error/write-verbose is used here, just quotes for it. The developer and github community is looking to improve this, but at this time, don&rsquo;t expect logging or error messages to come through the same way.</p>

<p>Be prepared to deal with some complications on error handling when dealing with runspaces, as even though they are more performant, there is a lot of issues with scope to deal with in those isolated runspaces. Once you start increasing the size of the script blocks things can get hard to debug.</p>

<p><strong>I think the simpler the task to pass into the parallel tasks, the better.</strong></p>

<p>However, for some basic tasks that would benefit in parallel, you can definitely give it a shot.
This task focused on iterating through a directory recursively and cleaning up each of the files by stripping out comments and blank lines. The following results were a simple example and interesting to compare.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">    -------- Summary with PoshRSJobs--------
    File Size:   9.59 MB
    Total Count: 4,600.00
    Filepath: C:\temp\MyCleanedUpZip.zip
    Total Original Lines: 1221673
    Total Lines: 1,201,746.00
    Total Lines Saved:  21,959.00
    TOTAL TIME TO RUN: 08:43

    -------- Summary with Invoke-Parallel --------
    File Size:   6.69 MB
    Total Count: 4,447.00
    Filepath: C:\temp\MyCleanedUpZip.zip
    Total Original Lines: 1221436
    Total Lines: 854,375.00
    Total Lines Saved:  360,045.00
    TOTAL TIME TO RUN: 05:22</code></pre></div>
<p>PoshRSJobs seemed to approach creating the job list first, which took a long time, and then processed the output very quickly. Overall, this took longer for this type of task. Invoke-Parallel gave an almost instant response showing the progress bar with estimated time remaining, so for this type of job it actually ran faster.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">    -------- Summary - Native ForEach --------
    File Size:   6.69 MB
    Total Count: 4,621.00
    Filepath: C:\temp\MyCleanedUpZip.zip
    Total Original Lines: 1227408
    Total Lines: 861,600.00
    Total Lines Saved:  365,808.00
    TOTAL TIME TO RUN: 04:52</code></pre></div>
<p>Surprising to me, the native foreach which was single threaded was faster. I believe in this case, the overhead of setting up the jobs was not worth parallel task processing. Since the task was a lot of small tasks, this probably wasn&rsquo;t a good candidate for parallel tasks. Based on this small test case, I&rsquo;d venture to look into parallel tasks when longer run times are involved, such as perhaps copying large files that aren&rsquo;t oversaturating your IO. In this case, slow long copies would probably benefit from parallel tasks, while small text file copies as I showed wouldn&rsquo;t.
A simple example of the difference in syntax for using PSParallel would be just counting lines in files in a directory.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$Folder</span> <span class="p">=</span> <span class="s1">&#39;C:\Temp&#39;</span>
<span class="nv">$startTime</span> <span class="p">=</span> <span class="nb">get-date</span>
<span class="no">[int]</span><span class="nv">$TotalManualCount</span> <span class="p">=</span> <span class="n">0</span>
<span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$Folder</span> <span class="n">-Recurse</span> <span class="n">-Force</span> <span class="s1">&#39; where { ! $_.PSIsContainer } &#39;</span> <span class="p">%</span> <span class="p">{</span> <span class="nv">$TotalManualCount</span> <span class="p">+=</span> <span class="p">(</span><span class="nb">Get-Content</span> <span class="n">-Path</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">FullName</span><span class="p">)</span> <span class="n">-Force</span> <span class="s1">&#39; Measure-Object -Line).Lines}
</span><span class="s1">write-host (&#39;</span><span class="n">Total</span> <span class="n">Lines</span><span class="err">:</span> <span class="p">{</span><span class="n">0</span><span class="err">:</span><span class="n">N2</span><span class="p">}</span><span class="s1">&#39; -f $TotalManualCount)
</span><span class="s1">Write-host (&#39;</span><span class="k">FOREACH</span><span class="err">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="n">to</span> <span class="k">process</span><span class="err">:</span> <span class="p">{</span><span class="n">0</span><span class="p">}</span><span class="s1">&#39; -f [timespan]::fromseconds(((Get-Date)-$StartTime).Totalseconds).ToString(&#39;</span><span class="n">mm</span><span class="p">\</span><span class="err">:</span><span class="n">ss</span><span class="s1">&#39;))
</span><span class="s1">#Using Invoke-Parallel#
</span><span class="s1">$ManualCount = [hashtable]::Synchronized(@{})
</span><span class="s1">$ManualCount = @{
</span><span class="s1">TotalCount     = 0
</span><span class="s1">}
</span><span class="s1">$Folder = &#39;</span><span class="n">C</span><span class="err">:</span><span class="p">\</span><span class="n">Temp</span><span class="s1">&#39;
</span><span class="s1">$startTime = get-date
</span><span class="s1">Get-ChildItem -Path $Folder -Recurse -Force &#39;</span> <span class="n">where</span> <span class="p">{</span> <span class="p">!</span> <span class="nv">$_</span><span class="p">.</span><span class="n">PSIsContainer</span> <span class="p">}</span> <span class="s1">&#39; Start-RsJob -Throttle 4 -ArgumentList $ManualCount -ScriptBlock {
</span><span class="s1">[cmdletbinding()]
</span><span class="s1">param($ManualCount)
</span><span class="s1">$ManualCount.TotalCount += (Get-Content -Path ($_.FullName) -Force &#39;</span> <span class="nb">Measure-Object</span> <span class="n">-Line</span><span class="p">).</span><span class="n">Lines</span>
<span class="p">}</span>
<span class="nb">write-host</span> <span class="p">(</span><span class="s1">&#39;Total Lines: {0:N2}&#39;</span> <span class="o">-f</span> <span class="nv">$ManualCount</span><span class="p">.</span><span class="n">TotalCount</span><span class="p">)</span>
<span class="nb">Write-host</span> <span class="p">(</span><span class="s1">&#39;INVOKE-PARALLEL: Total time to process: {0}&#39;</span> <span class="o">-f</span> <span class="no">[timespan]</span><span class="p">::</span><span class="n">fromseconds</span><span class="p">(((</span><span class="nb">Get-Date</span><span class="p">)-</span><span class="nv">$StartTime</span><span class="p">).</span><span class="n">Totalseconds</span><span class="p">).</span><span class="n">ToString</span><span class="p">(</span><span class="s1">&#39;mm\:ss&#39;</span><span class="p">))</span></code></pre></div>
<p>Note that this simple code example might have had some issues with counts due to locking with the synchronized hash table usage. Based on a few searches, it looks like you need to implement a lock on the hash table which ensures that particular thread is able to safely update. I didn&rsquo;t find clear proof that the synchronized hash table was working or failing, but it&rsquo;s something to be aware of. There are some active efforts on improving in PoshRSJob github issues.
Hopefully you&rsquo;ll have a few new ideas on working with Parallel tasks in powershell now, and think about leveraging it for some tedious tasks that might benefit with SQL server or other administrative jobs.</p>

		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.sheldonhull.com"></a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.sheldonhull.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.sheldonhull.com/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
