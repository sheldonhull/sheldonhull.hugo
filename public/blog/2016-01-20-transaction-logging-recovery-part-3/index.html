<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta itemprop="name" content="Transaction Logging &amp; Recovery (part 3)">
<meta itemprop="description" content="Continuation of some notes regarding the excellent content by Paul Randal in Pluralsight: SQL Server: Logging, Recovery, and the Transaction Log. Please consider supporting his excellent material by using Pluralsight and subscribing to his blog. He&rsquo;s contributed a vast amount to the SQL server community through SQLSkills This is my absorbing of key elements that I never had worked through
Jackalopes Are Real&hellip;.so are Virtual Log Files Ever seen a picture of a jackalope?">


<meta itemprop="datePublished" content="2016-01-20T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-01-20T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1014">



<meta itemprop="keywords" content="sql-server," />
<meta property="og:title" content="Transaction Logging &amp; Recovery (part 3)" />
<meta property="og:description" content="Continuation of some notes regarding the excellent content by Paul Randal in Pluralsight: SQL Server: Logging, Recovery, and the Transaction Log. Please consider supporting his excellent material by using Pluralsight and subscribing to his blog. He&rsquo;s contributed a vast amount to the SQL server community through SQLSkills This is my absorbing of key elements that I never had worked through
Jackalopes Are Real&hellip;.so are Virtual Log Files Ever seen a picture of a jackalope?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sheldonhull.com/blog/2016-01-20-transaction-logging-recovery-part-3/" />
<meta property="article:published_time" content="2016-01-20T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-01-20T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Transaction Logging &amp; Recovery (part 3)"/>
<meta name="twitter:description" content="Continuation of some notes regarding the excellent content by Paul Randal in Pluralsight: SQL Server: Logging, Recovery, and the Transaction Log. Please consider supporting his excellent material by using Pluralsight and subscribing to his blog. He&rsquo;s contributed a vast amount to the SQL server community through SQLSkills This is my absorbing of key elements that I never had worked through
Jackalopes Are Real&hellip;.so are Virtual Log Files Ever seen a picture of a jackalope?"/>

	<link rel="apple-touch-icon" sizes="180x180" href="https://www.sheldonhull.com/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.sheldonhull.com/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.sheldonhull.com/favicon-16x16.png">
	<link rel="manifest" href="https://www.sheldonhull.com/site.webmanifest">
	<link rel="mask-icon" href="https://www.sheldonhull.com/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="https://www.sheldonhull.com/favicon.ico">

	<title>Transaction Logging &amp; Recovery (part 3)</title>
	<link rel="stylesheet" href="https://www.sheldonhull.com/css/style.min.31706917653d2b9e8410abd431f30ec4359a88a94fc87a63654779d87329edec.css" integrity="sha256-MXBpF2U9K56EEKvUMfMOxDWaiKlPyHpjZUd52HMp7ew=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.sheldonhull.com">sheldonhull.com</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.sheldonhull.com/blog/">Blog</a>
					<a href="https://www.sheldonhull.com/docs/">Docs</a>
					<a href="https://www.sheldonhull.com/tags/">Tags</a>
					<a href="https://www.sheldonhull.com/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.sheldonhull.com/blog/">Blog</a></li>
			<li><a href="https://www.sheldonhull.com/docs/">Docs</a></li>
			<li><a href="https://www.sheldonhull.com/tags/">Tags</a></li>
			<li><a href="https://www.sheldonhull.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>Transaction Logging &amp; Recovery (part 3)</h1>
		<div class="content">
			

<p>Continuation of some notes regarding the excellent content by Paul Randal in <a href="http://www.pluralsight.com/courses/sqlserver-logging">Pluralsight: SQL Server: Logging, Recovery, and the Transaction Log</a>.
Please consider supporting his excellent material by using Pluralsight and subscribing to his <a href="http://www.sqlskills.com/blogs/paul/">blog</a>. He&rsquo;s contributed a vast amount to the SQL server community through <a href="https://www.sqlskills.com/sql-server-resources/">SQLSkills</a> This is my absorbing of key elements that I never had worked through</p>

<h2 id="jackalopes-are-real-so-are-virtual-log-files">Jackalopes Are Real&hellip;.so are Virtual Log Files<a href="#jackalopes-are-real-so-are-virtual-log-files" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>Ever seen a picture of a jackalope?
<a href="https://www.flickr.com/photos/46357488@N00/1778904004">Image by Mark Freeman (Jackalope, Grand Canyon North Rim, Oct 07) Creative Commons License</a></p>

<p>This is how I used to feel about Virtual Log Files. Folks were saying things like</p>

<ul>
<li>&ldquo;Your server may be slowing down because of those darn VLF&rsquo;s&rdquo;&hellip;..</li>
<li>&ldquo;Have you checked your VLF count&rdquo;&hellip;</li>
<li>&ldquo;My VLF count was x&rdquo; and more</li>
</ul>

<p>Finding clarification on VLF (Virtual Log Files) can be difficult, as what is considered a high count for some may be contradicted by another with another &ldquo;target VLF count&rdquo; claim.
Paul Randal unpacks this excellently in his class, providing some great transparency.</p>

<p><img src="https://www.sheldonhull.com/assets/img/jackalopes-are-real-so-are-virtual-log-files_ibbrwc.png" alt="jackalopes-are-real-so-are-virtual-log-files_ibbrwc" /></p>

<h2 id="why-should-i-care-about-vlfs">Why Should I Care About VLFs?<a href="#why-should-i-care-about-vlfs" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>In an excellent article regarding the performance impact analysis of VLF&rsquo;s, Linchi Shea provides some valuable insight into the impact.
For more detailed analysis &amp; graphs please look at this great article:
<a href="http://sqlblog.com/blogs/linchi_shea/archive/2009/02/09/performance-impact-a-large-number-of-virtual-log-files-part-i.aspx">Performance impact: a large number of virtual log files - Part I (2009)</a></p>

<ol>
<li>Inserts were about 4 times as slow</li>
<li>Updates were about 8 times slower</li>
<li>Deletes were about 5 times slower</li>
<li>Recovery time can be impacted <a href="http://blogs.msdn.com/b/grahamk/archive/2008/05/16/slow-recovery-times-and-slow-performance-due-to-large-numbers-of-virtual-log-files.aspx">Slow recovery times and slow performance due to large numbers of Virtual Log Files (2008)</a></li>
<li>Triggers &amp; Log Backups can be slowed down <a href="http://sqlblogcasts.com/blogs/tonyrogerson/archive/2007/07/25/sql-2000-yes-lots-of-vlf-s-are-bad-improve-the-performance-of-your-triggers-and-log-backups-on-2000.aspx">Tony Rogerson article (2007)</a></li>
</ol>

<h2 id="virtual-log-files">Virtual Log Files<a href="#virtual-log-files" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<ul>
<li>At the beginning of each log file is a header. This is 8kb header that contains settings like autogrowth &amp; size metadata.</li>
<li>Active VLF&rsquo;s are not free for usage until they are marked as available when clearing the log (see previous post about backups)</li>
<li>When you create a db you have one active VLF file, but as you progress more VLF&rsquo;s will be used.</li>
<li>Too few or too many VLF&rsquo;s can cause problems.</li>
</ul>

<h3 id="vlf-count">VLF Count<a href="#vlf-count" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<ul>
<li>You cannot change the number and size of VLF&rsquo;s in a new portion of the transaction log. This is SQL server driven.</li>
<li>The VLF size is determined by a formula.</li>
<li>For detailed breakdown of the changes that SQL 2014 brought for the VLF algorithm, see this excellent post by Paul Randal: <a href="http://www.sqlskills.com/blogs/paul/important-change-vlf-creation-algorithm-sql-server-2014/">Important change to VLF creation algorithm in SQL Server 2014 </a>
Since I&rsquo;m working with SQL 2014, I found it interesting as the increased VLF count issue that can be impacting to server performance has been greatly improved. Paul&rsquo;s example cited that the number of VLF&rsquo;s in his example would result in 3192 VLF prior to 2014, but with SQL 2014 it decreased down to 455, which is a substantial improvement. Paul indicated that the prior algorithm was designed primarily for around 1997-1980&rsquo;s, when <a href="http://www.sqlskills.com/blogs/paul/important-change-vlf-creation-algorithm-sql-server-2014/#comment-643223">log files wouldn&rsquo;t be sized as large.</a>
Also note a critical question that he <a href="http://www.sqlskills.com/blogs/paul/important-change-vlf-creation-algorithm-sql-server-2014/">answers</a>: <strong><em>COMPATIBILITY LEVEL IS IGNORED BY THE STORAGE ENGINE PROCESSOR</em></strong>
This is great information he&rsquo;s shared, as I&rsquo;ve found it confusing at times to separate out the Query Engine impact from compatibility level, and understanding this scope of impact can help with assessing possible impact.</li>
</ul>

<h3 id="more-detail-than-you-ever-wanted-to-know-on-vlf-s">More Detail than You Ever Wanted to Know on VLF&rsquo;s<a href="#more-detail-than-you-ever-wanted-to-know-on-vlf-s" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<ul>
<li>VLF&rsquo;s internally contain log block sizes. 512-60KB.</li>
<li>When the log block is filled it must be flushed to disk.</li>
<li>Within the log block are the log records.</li>
<li>VLF&rsquo;s contain a header. This indicates whether or not the VLF is active or not, LSN, and parity bits.</li>
<li>VLF log records support multiple concurrent threads, so the associated transaction records don&rsquo;t have to be grouped.</li>
<li>LSN. I&rsquo;ve heard the term used, but until you understand the pieces above, the term won&rsquo;t make sense. - Log Sequence Number = VLF Sequence Number : Log Block Number : Log Record</li>
<li>They are important as the LSN is stamped on the data file to show the most recent log record it reflects, letting sql server know during crash recovery that recovery needs to occur or not.</li>
</ul>

<h3 id="number-of-log-files">Number of Log Files<a href="#number-of-log-files" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>This is determine by a formula that has been updated for 2014.</p>

<ul>
<li>Different size growths have different number of VLFs.</li>
<li>VLF&rsquo;s don&rsquo;t care about the total size, but instead about the growth.</li>
<li>For instance, Above 1 GB growth events on log file will split into 16 new VLF&rsquo;s, <sup>1</sup>&frasl;<sub>16</sub>.</li>
</ul>

<h3 id="faq-i-ve-asked-and-looked-for-some-answers">FAQ (I&rsquo;ve asked and looked for some answers!)<a href="#faq-i-ve-asked-and-looked-for-some-answers" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>**Create small log and then expand or create larger log initially? **</p>

<blockquote>
<p><a href="http://www.sqlskills.com/blogs/paul/important-change-vlf-creation-algorithm-sql-server-2014/#comment-811320">Paul Randal answered: </a> No. If I was creating, say a 64 GB log, I&rsquo;d create it as 8GB then expand in 8GB chunks to 64GB to keep the number of VLFs small. That means each VLF will be 0.5 GB, which is a good size.
<strong>What is the ideal l number of VLFs?</strong>
Some key articles I&rsquo;ve found for detailed answers on understanding proper VLF count:</p>

<ol>
<li><a href="http://www.sqlskills.com/blogs/kimberly/transaction-log-vlfs-too-many-or-too-few/">Transaction Log VLFs - too many or too few (2008)</a></li>
<li><a href="http://www.sqlskills.com/blogs/kimberly/8-steps-to-better-transaction-log-throughput/">8 Steps to better Transaction Log throughput (2005)</a></li>
<li><a href="http://adventuresinsql.com/2009/12/a-busyaccidental-dbas-guide-to-managing-vlfs/">A Busy/Accidental DBA&rsquo;s Guide to Managing VLFs (2009)</a>
Resources</li>
<li><a href="http://www.brentozar.com/blitz/high-virtual-log-file-vlf-count/">Brentozar SP_BLITZ will check VLF counts</a>
<strong>How do I ensure my log file gets marked as available for reuse when in full recovery?</strong>
Full recovery is required for point-in-time recovery after a failure. This is because every change to data or to database objects are written to the transaction log prior to being committed. These transactions are then written to the data file as SQL Server sees fit after this initial write to disk. The transaction log is a rolling history of all changes in the database and will allow for redo of each transaction in case of failure to rebuild the state of the data at failure. In the case of Full Recovery, the transaction log continues to expand until a checkpoint is issued via a successful transaction log backup. <a href="http://thesqlagentman.com/2012/03/top-13-sql-server-mistakes-and-missteps-10-default-database-autogrowth-settings/">Top 13 SQL Server Mistakes and Misteps (2012)</a> This great article by Tim Ford should be reviewed, as it&rsquo;s one of the best simple breakdowns of growth issues and prevention that I&rsquo;ve read.</li>
</ol>
</blockquote>

		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.sheldonhull.com"></a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.sheldonhull.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.sheldonhull.com/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
