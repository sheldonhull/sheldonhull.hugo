<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta itemprop="name" content="Continual Deployment of Visual Studio SqlProj">
<meta itemprop="description" content="Unveil the inner workings of the esoteric build system&hellip; As a data professional, I&rsquo;ve never worked extensively with msbuild or other pipelines. I&rsquo;d been mostly focused on just running schema comparisons and publishing. However, I&rsquo;ve had the needed to try and deploy a database project from visual studio automatically, and this is my process through it.
There are benefits for those who don&rsquo;t necessarily want to run this against production, but instead for those who want to continually deploy check-ins and run tests, documentation, or other tasks against the deployed schema.">


<meta itemprop="datePublished" content="2016-05-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-05-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="903">



<meta itemprop="keywords" content="sql-server,cool-tools," />
<meta property="og:title" content="Continual Deployment of Visual Studio SqlProj" />
<meta property="og:description" content="Unveil the inner workings of the esoteric build system&hellip; As a data professional, I&rsquo;ve never worked extensively with msbuild or other pipelines. I&rsquo;d been mostly focused on just running schema comparisons and publishing. However, I&rsquo;ve had the needed to try and deploy a database project from visual studio automatically, and this is my process through it.
There are benefits for those who don&rsquo;t necessarily want to run this against production, but instead for those who want to continually deploy check-ins and run tests, documentation, or other tasks against the deployed schema." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sheldonhull.com/blog/2016-05-16-continual-deployment-of-visual-studio-sql-proj/" />
<meta property="article:published_time" content="2016-05-16T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-05-16T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Continual Deployment of Visual Studio SqlProj"/>
<meta name="twitter:description" content="Unveil the inner workings of the esoteric build system&hellip; As a data professional, I&rsquo;ve never worked extensively with msbuild or other pipelines. I&rsquo;d been mostly focused on just running schema comparisons and publishing. However, I&rsquo;ve had the needed to try and deploy a database project from visual studio automatically, and this is my process through it.
There are benefits for those who don&rsquo;t necessarily want to run this against production, but instead for those who want to continually deploy check-ins and run tests, documentation, or other tasks against the deployed schema."/>

	<link rel="apple-touch-icon" sizes="180x180" href="https://www.sheldonhull.com/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.sheldonhull.com/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.sheldonhull.com/favicon-16x16.png">
	<link rel="manifest" href="https://www.sheldonhull.com/site.webmanifest">
	<link rel="mask-icon" href="https://www.sheldonhull.com/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="https://www.sheldonhull.com/favicon.ico">

	<title>Continual Deployment of Visual Studio SqlProj</title>
	<link rel="stylesheet" href="https://www.sheldonhull.com/css/style.min.31706917653d2b9e8410abd431f30ec4359a88a94fc87a63654779d87329edec.css" integrity="sha256-MXBpF2U9K56EEKvUMfMOxDWaiKlPyHpjZUd52HMp7ew=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.sheldonhull.com">sheldonhull.com</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.sheldonhull.com/blog/">Blog</a>
					<a href="https://www.sheldonhull.com/docs/">Docs</a>
					<a href="https://www.sheldonhull.com/tags/">Tags</a>
					<a href="https://www.sheldonhull.com/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.sheldonhull.com/blog/">Blog</a></li>
			<li><a href="https://www.sheldonhull.com/docs/">Docs</a></li>
			<li><a href="https://www.sheldonhull.com/tags/">Tags</a></li>
			<li><a href="https://www.sheldonhull.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>Continual Deployment of Visual Studio SqlProj</h1>
		<div class="content">
			

<h2 id="unveil-the-inner-workings-of-the-esoteric-build-system">Unveil the inner workings of the esoteric build system&hellip;<a href="#unveil-the-inner-workings-of-the-esoteric-build-system" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>As a data professional, I&rsquo;ve never worked extensively with msbuild or other pipelines. I&rsquo;d been mostly focused on just running schema comparisons and publishing. However, I&rsquo;ve had the needed to try and deploy a database project from visual studio automatically, and this is my process through it.</p>

<p>There are benefits for those who don&rsquo;t necessarily want to run this against production, but instead for those who want to continually deploy check-ins and run tests, documentation, or other tasks against the deployed schema. This was my personal goal.</p>

<p>There are other solutions that plug into this that can make the process easier, such as Red Gate&rsquo;s DLM Automation with SQL Continuous Integration. For this case, since migrating to a new project format wasn&rsquo;t possible until later, I worked with the native sql project from the SQL Server Data Tools in Visual Studio 2015.</p>

<h2 id="terminology">Terminology<a href="#terminology" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<ul>
<li>Build Controller: This is like Service broker. It handles the queuing and assignment of the defined builds to the appropriate agents. It doesn&rsquo;t do any actual building, but instead handles the delegation of the work.</li>
<li>Build Agent: This is the &ldquo;wrapper&rdquo; for msbuild. It does the actual work of building whatever you pass to it.</li>
</ul>

<h2 id="initial-setup-install">Initial Setup &amp; Install<a href="#initial-setup-install" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<ol>
<li><p>Configure Build Service Wizard
Choose the configure option of just the build service
<img src="https://www.sheldonhull.com/assets/img/configure-build-service-wizard.png" alt="Configure Build Service Wizard" /></p></li>

<li><p>Configure collection <img src="https://www.sheldonhull.com/assets/img/configure-collection.png" alt="Configure collection" /></p></li>

<li><p>Choose configuration options for the build services
<img src="https://www.sheldonhull.com/assets/img/choose-configuration-options-for-the-build-services.png" alt="Choose configuration options for the build services" /></p></li>

<li><p>Setup build service account
<img src="https://www.sheldonhull.com/assets/img/setup-build-service-account.png" alt="Setup build service account" /></p></li>

<li><p>Finished with configuration. After running checks and resolving any issues (I thankfully had none for this simple install of just build controller/agent; you can proceed
<img src="https://www.sheldonhull.com/assets/img/finished-with-configuration.png" alt="Finished with configuration" /></p></li>

<li><p>Create Build Agents
<img src="https://www.sheldonhull.com/assets/img/create-build-agents.png" alt="Create Build Agents" /></p></li>
</ol>

<h2 id="future-configuration-of-build-agents">Future Configuration of Build Agents<a href="#future-configuration-of-build-agents" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>Once you&rsquo;ve finished the install of the build service and agents, you need to configure them. After completing the install the Team Foundation Server Administration Console should open, if not open manually (start menu)</p>

<ol>
<li>Review build service configuration
<img src="https://www.sheldonhull.com/assets/img/review-build-service-configuration.png" alt="Review build service configuration" /></li>
<li>Build Configuration Pane
<img src="https://www.sheldonhull.com/assets/img/build-configuration-pane.png" alt="Build Configuration Pane" /></li>
<li>Reviewing Build Agent Properties
<img src="https://www.sheldonhull.com/assets/img/reviewing-build-agent-properties.png" alt="Reviewing Build Agent Properties" /></li>
</ol>

<h2 id="setup-of-build">Setup of Build<a href="#setup-of-build" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<ol>
<li><p>Create new build
<img src="https://www.sheldonhull.com/assets/img/create-new-build.png" alt="Create new build" /></p></li>

<li><p>set trigger to continous integration
<img src="https://www.sheldonhull.com/assets/img/set-trigger-to-continous-integration.png" alt="set trigger to continous integration" /></p></li>

<li><p>map your working folder to the database project
<img src="https://www.sheldonhull.com/assets/img/map-your-working-folder-to-the-database-project.png" alt="map your working folder to the database project" /></p></li>

<li><p>setup the process details
Make sure to the map the project to the .sqlproj file to only build the sqlproj. You can adjust other items as you desire, but this should cover the core settings.
<img src="https://www.sheldonhull.com/assets/img/setup-the-process-details.png" alt="setup the process details" /></p></li>

<li><p>Copy Local
Make sure to have the new profile copied locally as part of the build or it won&rsquo;t have any publish profile copied when the build is triggered, and therefore might result in hours of you wondering why it is ignoring your profile target settings (true story). You can configure to not do this of course, if you want to have a fixed file on your drive instead of copying from source control each time. <a href="http://bit.ly/221zgxS">Recommendation - Prepare a Publish Profile file</a>
<img src="https://www.sheldonhull.com/assets/img/copy-local.png" alt="Copy Local" /></p></li>

<li><p>Setup Parameters for Build
The arguments I choose to use were:
(note the publishprofile parameter which wasn&rsquo;t in older versions of SSDT)</p>

<p>/t:Build /t:Publish /p:SqlPublishProfilePath=foobar.publish.xml&rdquo; /p:PublishScriptFileName=foobar.publish.sql /p:TargetDatabaseName=&ldquo;foobar&rdquo;;TargetConnectionString=&ldquo;Data Source=localhost;Integrated Security=True;Pooling=False&rdquo; /p:PreBuildEvent= /p:PostBuildEvent=  /p:VisualStudioVersion=14.0</p></li>
</ol>

<p>The infuriating thing about working through this is that when it doesn&rsquo;t find the publish profile, it defaults to the &ldquo;Deploy&rdquo; settings, so in my case it kept trying to deploy the changes to a local database named the same thing as my project. Please don&rsquo;t waste the same amount of time grinding your teeth at MSBuild as I did, and watch out for the paths to be correct! Make sure you have it set to copy the publish profile over or it will not exist and default to the deploy settings.</p>

<p>When I omitted the VisualStudioVersion option, it had an error &ldquo;unable to connect to target server&rdquo;&hellip;&hellip; 2 days of work later I realized the version parameter was critical for it to use the right msbuild version and deploy. I didn&rsquo;t go into more research on this, so feel free to comment if you more details on this.</p>

<p><img src="https://www.sheldonhull.com/assets/img/setup-parameters-for-build.png" alt="Setup Parameters for Build" /></p>

<h2 id="running-msbuild-manually">Running MSBuild Manually<a href="#running-msbuild-manually" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>A few tips from my work with launching the process to build the database locally, if you experience an issues. This is work I was doing with MSBUILD 14 (visual studio 2015). I would trigger msbuild and it would deploy the database, but never exit the process to report success to powershell allowing my script to continue.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">/p:UseSharedCompilation=false               --&gt; (Roslyn compiler bypassed http://bit.ly/1WmMVzx)
/m:4                                        --&gt; (limit to only 4 cores http://bit.ly/1VSl9uF)
/nr:false                                   --&gt; same link above
/verbosity:quiet
/p:Configuration=Release                    --&gt; don&#39;t need debugging for this output, so just output release
/p:DebugSymbols=false                       --&gt; no need for extra debugging, potential improvement in timing to get rid of this
/p:DebugType=None
/t:Build;Deploy                     --&gt; optional. Could rebuild if you want to
/p:PreBuildEvent=                   --&gt; bypass any prebuild/post build events if you have something doing copying of files around (optional)
update after got everything working:
/p:VisualStudioVersion=14.0 --&gt; ensure you match the version of msbuild you need</code></pre></div>
<p>Optional: If you have further issues with 2015 and want to disable globally the node reuse settings then you can do this with a registry entry. Following the directions from <a href="https://techdocs.ed-fi.org/display/ODSAPI20/Step+4.+Prepare+the+Development+Environment">TechDocs</a> I did this.</p>

<p><img src="https://www.sheldonhull.com/assets/img/running-msbuild-manually.png" alt="Running MSBuild Manually" /></p>

<h2 id="resources">Resources<a href="#resources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<h3 id="msdn-documentation-tasks">MSDN Documentation Tasks<a href="#msdn-documentation-tasks" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>Creating tasks is documented in</p>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/t9883dzc(v=vs.120).aspx">Task Writing: Visual Studio 2013</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/ms171466(v=vs.120).aspx">MsBuild Tasks</a></li>
</ul>

<p>The MSBuild XML project file format cannot fully execute build operations on its own, so task logic must be implemented outside of the project file.
The execution logic of a task is implemented as a .NET class that implements the ITask interface, which is defined in the Microsoft.Build.Framework namespace.</p>

<p>The task class also defines the input and output parameters available to the task in the project file. <a href="https://msdn.microsoft.com/en-us/library/ms171466(v=vs.120).aspx#Anchor_0">MSBuild Tasks</a></p>

		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.sheldonhull.com"></a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.sheldonhull.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.sheldonhull.com/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
