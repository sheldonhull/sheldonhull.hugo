<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta itemprop="name" content="Fixing Untrusted Foreign Key or Check Constraint">
<meta itemprop="description" content="Untrusted constraints can be found when you alter/drop foreign key relationships and then add them back without the proper syntax.If you are deploying data through several tables, you might want to disable foreign keys on those tables during the deployment to ensure that all the required relationships have a chance to insert their data before validation.
Once you complete the update, you should run a check statement to ensure the Foreign Key is trusted.">


<meta itemprop="datePublished" content="2016-10-22T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-10-22T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="308">



<meta itemprop="keywords" content="sql-server," />
<meta property="og:title" content="Fixing Untrusted Foreign Key or Check Constraint" />
<meta property="og:description" content="Untrusted constraints can be found when you alter/drop foreign key relationships and then add them back without the proper syntax.If you are deploying data through several tables, you might want to disable foreign keys on those tables during the deployment to ensure that all the required relationships have a chance to insert their data before validation.
Once you complete the update, you should run a check statement to ensure the Foreign Key is trusted." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sheldonhull.com/blog/2016-10-22-fixing-untrusted-foreign-key-or-check-constraint/" />
<meta property="article:published_time" content="2016-10-22T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-10-22T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fixing Untrusted Foreign Key or Check Constraint"/>
<meta name="twitter:description" content="Untrusted constraints can be found when you alter/drop foreign key relationships and then add them back without the proper syntax.If you are deploying data through several tables, you might want to disable foreign keys on those tables during the deployment to ensure that all the required relationships have a chance to insert their data before validation.
Once you complete the update, you should run a check statement to ensure the Foreign Key is trusted."/>

	<link rel="apple-touch-icon" sizes="180x180" href="https://www.sheldonhull.com/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://www.sheldonhull.com/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://www.sheldonhull.com/favicon-16x16.png">
	<link rel="manifest" href="https://www.sheldonhull.com/site.webmanifest">
	<link rel="mask-icon" href="https://www.sheldonhull.com/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="https://www.sheldonhull.com/favicon.ico">

	<title>Fixing Untrusted Foreign Key or Check Constraint</title>
	<link rel="stylesheet" href="https://www.sheldonhull.com/css/style.min.31706917653d2b9e8410abd431f30ec4359a88a94fc87a63654779d87329edec.css" integrity="sha256-MXBpF2U9K56EEKvUMfMOxDWaiKlPyHpjZUd52HMp7ew=">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.sheldonhull.com">sheldonhull.com</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					<a href="https://www.sheldonhull.com/blog/">Blog</a>
					<a href="https://www.sheldonhull.com/docs/">Docs</a>
					<a href="https://www.sheldonhull.com/tags/">Tags</a>
					<a href="https://www.sheldonhull.com/about/">About</a>
				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.sheldonhull.com/blog/">Blog</a></li>
			<li><a href="https://www.sheldonhull.com/docs/">Docs</a></li>
			<li><a href="https://www.sheldonhull.com/tags/">Tags</a></li>
			<li><a href="https://www.sheldonhull.com/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>Fixing Untrusted Foreign Key or Check Constraint</h1>
		<div class="content">
			<p>Untrusted constraints can be found when you alter/drop foreign key relationships and then add them back without the proper syntax.If you are deploying data through several tables, you might want to disable foreign keys on those tables during the deployment to ensure that all the required relationships have a chance to insert their data before validation.</p>

<p>Once you complete the update, you should run a check statement to ensure the Foreign Key is trusted.
The difference in the check syntax is actually ridiculous&hellip;.
This check would not ensure the actual existing rows are validated to ensure compliance with the Foreign Key constraint.</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">alter</span> <span class="k">table</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ChickenLiver</span><span class="p">]</span> <span class="k">with</span> <span class="k">check</span> <span class="k">constraint</span> <span class="p">[</span><span class="n">FK_EggDropSoup</span><span class="p">]</span></code></pre></div>
<p>This check would check the rows contained in the table for adherence to the foreign key relationship and only succeed if the FK was successfully validated. This flags metadata for the database engine to know the key is trusted.</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">alter</span> <span class="k">table</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ChickenLiver</span><span class="p">]</span> <span class="k">with</span> <span class="k">CHECK</span> <span class="k">CHECK</span> <span class="k">constraint</span> <span class="p">[</span><span class="n">FK_EggDropSoup</span><span class="p">]</span></code></pre></div>
<p>I originally worked through this after running sp_Blitz and working through the helpful documentation explaining <a href="http://bit.ly/2efZTkr">Foreign Keys or Check Constraints Not Trusted</a>.</p>

<p>Untrusted Check Constraints and FKs can actually impact the performance of the query, leading to a less optimal query plan. The query engine won&rsquo;t know necessarily that the uniqueness of a constraint, or a foreign key is guaranteed at this point.</p>

<p>I forked the script from Brent&rsquo;s link above and modified to iterate through and generate the script for running the check against everything in the database. This could be modified to be server wide if you wish as well. Original DMV query credit to Brent, and the the tweaks for running them against the database automatically are my small contribution.</p>

<p>Note: I wrote on this a while back, totally missed that I had covered this. For an older perspective on this: <a href="{% post_url 2015-08-13-stranger-danger...-the-need-for-trust-with-constraints %}">Stranger Danger&hellip; The need for trust with constraints</a></p>

<script type="text/javascript" src="https://gist.github.com/2454ce9134eac225ce264c64adb331a9.js"></script>


		</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://www.sheldonhull.com"></a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.sheldonhull.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.sheldonhull.com/js/main.min.784417f5847151f848c339cf0acb13a06cbb648b1483435a28ed4556c4ead69b.js" integrity="sha256-eEQX9YRxUfhIwznPCssToGy7ZIsUg0NaKO1FVsTq1ps="></script>

</body>

</html>
