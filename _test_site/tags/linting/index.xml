<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0" xmlns:dc='http://purl.org/dc/elements/1.1/'>
    <channel>
        <title>Linting - Tag - sheldonhull.com</title>
        <link>https://www.sheldonhull.com/tags/linting/</link>
        <description>Linting - Tag - sheldonhull.com</description>
        <generator>Hugo -- gohugo.io</generator><language>en</language><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Wed, 16 Jun 2021 00:00:00 &#43;0000</lastBuildDate><atom:link href="https://www.sheldonhull.com/tags/linting/" rel="self" type="application/rss+xml" />

<item>
    <title>
        precommit
    </title>
    <link>
        https://www.sheldonhull.com/notes/development/tooling/precommit/
    </link>
    <pubDate>
        Wed, 16 Jun 2021 00:00:00 &#43;0000
    </pubDate>
    
    
    <guid>
        https://www.sheldonhull.com/notes/development/tooling/precommit/
    </guid>
    <description>
        <![CDATA[
        
        
        
            
        
        <p>A cheatsheet for various pre-commit hooks and things that help with linting, formatting, code scans and more. These all help &ldquo;shift left&rdquo; the review to eliminate more issues in the development workflow, rather than providing feedback only once the CI system is involved.</p>
<h2 id="the-frameworks" class="headerLink">
    <a href="#the-frameworks" class="header-mark"></a>The Frameworks</h2><ul>
<li><a href="https://github.com/evilmartians/lefthook/" target="_blank" rel="noopener noreferrer">GitHub - evilmartians/lefthook: Fast and powerful Git hooks manager for any type of projects.</a> is a newer project based in Go.</li>
<li><a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">pre-commit</a> is python-based, very mature and supported.</li>
</ul>
<h2 id="precommit" class="headerLink">
    <a href="#precommit" class="header-mark"></a>Precommit</h2><h3 id="install-precommit" class="headerLink">
    <a href="#install-precommit" class="header-mark"></a>Install Precommit</h3><p>A bit more complicated, depending on the Docker image used and the python tooling installed.
Assuming you have pip installed, then run <code>pip install pre-commit --user</code></p>
<p>Here are some examples to get you started.</p>
<h2 id="skipping-a-precommit-hook" class="headerLink">
    <a href="#skipping-a-precommit-hook" class="header-mark"></a>Skipping A Precommit Hook</h2><p>The pre-commit tasks can be overridden on a case-by-case basis.</p>
<p>The syntax for skipping is simple, just run the task with the name of the hook excluded like this:</p>
<pre><code>  Don't commit to main.....................................................Passed
  check json5..........................................(no files to check)Skipped
  go-fmt...................................................................Passed
  golangci-lint...........................................................Skipped
  go-test-all..............................................................Failed
  - hook id: gotest ðŸ‘ˆðŸ‘ˆðŸ‘ˆðŸ‘ˆðŸ‘ˆðŸ‘ˆðŸ‘ˆðŸ‘ˆ  # Use the hook id, not the text of the title
  - duration: 8.9s
  - exit code: 2
</code></pre>
<ul>
<li>To skip the example above: <code>SKIP='gotest' git commit -am&quot;feat(fancy): my title&quot; -m&quot;- My Message Body&quot; &amp;&amp; git pull --rebase &amp;&amp; git push</code>.</li>
<li>To skip multiple: <code>SKIP='gotest,go-fmt' git myaction</code>.</li>
</ul>
<h2 id="filtering--triggering-tricks" class="headerLink">
    <a href="#filtering--triggering-tricks" class="header-mark"></a>Filtering &amp; Triggering Tricks</h2><p>Let&rsquo;s say you have a document directory and want to trigger a report or doc generation if anything in that changes.</p>
<p>You can do this pretty elegantly with pre-commit.</p>
<p>For example, let&rsquo;s add a mage task to generate docs when something in the package directory for go is updated.</p>
<pre><code>repos:
  # for specific updates that should result in an update to matched directories or files.
  - repo: local
    hooks:
      - id: docs:generate
        name: docs:generate
        entry: mage docs:generate
        language: system
        files: ^pkg/
        types: [file, go]
</code></pre>
<p>The types are pretty useful, not just to try and match on file names.</p>
<p>Use <code>identify-cli</code> which is a python cli and package included when you install pre-commit.</p>
<p>Run it against a directory or file and you&rsquo;ll get the outputs that pre-commit will accept.</p>
<p>For example, against a markdown file: <code>identify-cli README.md</code> and you should get: <code>[&quot;file&quot;, &quot;markdown&quot;, &quot;non-executable&quot;, &quot;text&quot;]</code>. Any of these (or all) can be used to filter when the hook runs.</p>
<p>Against a Go file: <code>[&quot;file&quot;, &quot;go&quot;, &quot;non-executable&quot;, &quot;text&quot;]</code>.</p>
<div
    class="details admonition info
      open
    "
  >
    <div class="details-summary admonition-title">
      <i
        class="icon fas fa-info-circle fa-fw"
      ></i>
      LeftHook
      <i class="details-icon fas fa-angle-right fa-fw"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">Using pre-commit framework heavily, and no longer relying on Lefthook.</div>
    </div>
  </div>
<h2 id="lefthook" class="headerLink">
    <a href="#lefthook" class="header-mark"></a>Lefthook</h2><p>A great tool, but requires more work and is not as fully featured as pre-commit.
In most cases, I&rsquo;d recommend pre-commit tooling over Lefthook.</p>
<p>If you are just starting out, this requires more hands-on work but can result in faster checks and commits.</p>
<p>My advice would be to start with pre-commit if you want plug and play, and lefthook if you want to control the pre-commits explicitly and optimize for performance.</p>
<p>As long as you have the Go SDK installed, just run <code>go install github.com/evilmartians/lefthook@master</code>.</p>
<p>This framework is a little &ldquo;rougher&rdquo; and less supported than pre-commit framework, but for simple self-maintained hooks, I&rsquo;ve preferred this as it is much faster, and so I end up using it more.</p>
<p>Other installation methods are located at the installation guide <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<h3 id="lefhook-tips" class="headerLink">
    <a href="#lefhook-tips" class="header-mark"></a>Lefhook Tips</h3><ul>
<li>Originally, I broke out lefthook into multiple files so I could drop them into a directory, but now I stick with one.
Since it still requires editing the main file to extend and point to another file, I&rsquo;ve found a single file simpler to maintain.</li>
<li>Disable parallel operation for anything formatting files or possibly not thread safe.
While parallel operation seems great, most of the pre-commit tasks should run quickly, and formatting and linting files at the same time could lead to conflicts or problems.
Use parallel operation for separate language test runs perhaps, like running Python tests and Go tests since those shouldn&rsquo;t conflict.</li>
<li><code>piped: true</code> is useful but hides the underlying tasks in the summary, so I suggest avoid unless you have tasks that really should feed into each other step by step.
In this case, maybe you should have this just be part of your task run, such as <code>mage lint fmt</code> rather than two separate pre-commit hooks.</li>
</ul>
<h3 id="using-lefthook" class="headerLink">
    <a href="#using-lefthook" class="header-mark"></a>Using Lefthook</h3><p>Here are some updated configurations I&rsquo;ve started using.</p>
<h4 id="output" class="headerLink">
    <a href="#output" class="header-mark"></a>Output</h4><p>Reduce the noise:</p>
<pre><code>skip_output:
  - meta
  - success
# - summary
skip:
  - merge
  - rebase
</code></pre>
<h4 id="pre-commit-checks" class="headerLink">
    <a href="#pre-commit-checks" class="header-mark"></a>Pre-commit Checks</h4><p>These are basic quick checks for markdown (docs as code).
This illustrates one of the challenges in pre-commit framework tooling.</p>
<p>Ideally, you want the pre-commit checks to only touch the files that changed to make things quick, but this requires some workarounds, since not all tools support a comma-delimited list of files passed in.</p>
<p>One big improvement to lefthook would be supporting a <code>for_each</code> operator, so that cross-platform looping on matched files could be run, instead of having to parse inside the script here.
I&rsquo;m pretty sure that this would be more compatible with various platforms as well, since this I believe uses your native shell, so you&rsquo;d have to be in WSL2 in Windows, for example, for the bash-like syntax to work.</p>
<p>See <a href="https://github.com/sheldonhull/ci-configuration-files/.markdownlint-cli2.yaml" target="_blank" rel="noopener noreferrer">ci-configuration-files</a> for markdown lint config examples.</p>
<p>Install <code>gojq</code> or replace with <code>jq</code> if you have it.</p>
<pre><code>pre-commit:
  tags: markdown fmt
  parallel: false
  commands:
    markdownlintfix:
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*{.md}'
      run: |
        echo &quot;âš¡ markdownlint on: {files}&quot;
        for file in {files}
        do
          echo &quot;ðŸ”¨ markdownlint: $file&quot;
          docker run --rm -v ${PWD}:/workdir --entrypoint=&quot;markdownlint-cli2-fix&quot; davidanson/markdownlint-cli2:latest &quot;$file&quot;
        done
    markdownlintcheck:
      files: git diff-index --name-only HEAD
      exclude: '_licenses/*'
      glob: '*{.md}'
      run: |
        echo &quot;âš¡ markdownlint on: {files}&quot;
        for file in {files}
        do
          echo &quot;ðŸ”¨ markdownlint: $file&quot;
          docker run --rm -v ${PWD}:/workdir --entrypoint=&quot;markdownlint-cli2&quot; davidanson/markdownlint-cli2:latest &quot;$file&quot;
        done
    shellcheck:
      tags: gotool gojq
      name: shellcheck
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*.sh'
      run: docker run --rm -v ${PWD}:/mnt koalaman/shellcheck:stable --format=json {files}  | gojq
    # REQUIREMENTS: npm install --global prettier
    yamlfmt:
      files: git diff-index --name-only HEAD
      glob: '*.yaml|*.yml'
      exclude: '.licenses/*'
      skip_empty: false
      run: prettier --loglevel warn --no-error-on-unmatched-pattern --write &quot;{.yaml,.yml}&quot;
    # REQUIREMENTS: go install go.atrox.dev/sync-dotenv@latest
    # used to sync default dotenv files to an example file to avoid commits on main .env
    envfile:
      name: update env.example file
      files: '*.env'
      exclude: '.licenses/*'
      run: |
        cd env
        touch .env
        sync-dotenv
    # REQUIREMENTS: Mage Tasks Built (See github.com/sheldonhull/magetools)
    # CI=1 helps reduce formatting output to minimal
    # MAGEFILE_HASHFAST improves speed of calling mage by assuming your tasks haven't changed
    go:
      piped: true
      tags: go lint fmt
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*.{go,mod,sum}'
      commands:
        fmt:
          run: CI=1 MAGEFILE_HASHFAST=1 mage fmt
        lint:
          run: CI=1 MAGEFILE_HASHFAST=1 mage lint
</code></pre>
<h4 id="pre-push-checks" class="headerLink">
    <a href="#pre-push-checks" class="header-mark"></a>Pre-Push Checks</h4><p>Most of these Mage-oriented tasks are from my magetools repo.</p>
<p>Note that while they filter based on the files being Go-related, they run against the entire repo.</p>
<pre><code>pre-push:
  parallel: false
  commands:
    fmt:
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*.{go,mod,sum}'
      run: CI=1 MAGEFILE_HASHFAST=1 mage go:wrap
    lint:
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*.{go,mod,sum}'
      run: CI=1 MAGEFILE_HASHFAST=1 mage lint
    test:
      files: git diff-index --name-only HEAD
      exclude: '.licenses/*'
      glob: '*.{go,mod,sum}'
      run: CI=1 MAGEFILE_HASHFAST=1 mage go:test
    gitleaks:
      tags: security gotool linux macos nowindows
      run: CI=1 MAGEFILE_HASHFAST=1 mage secrets:check
</code></pre>
<!-- links -->
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://github.com/evilmartians/lefthook/blob/master/docs/full_guide.md#installation" target="_blank" rel="noopener noreferrer">lefthook/full_guide.md at master Â· evilmartians/lefthook Â· GitHub</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

        ]]>
    <a href="https://brid.gy/publish/twitter"></a>
    <data class="p-bridgy-omit-link" value="false"></data>
    </description>
</item>
</channel>
</rss>
